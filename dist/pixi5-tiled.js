var TiledOG=function(e,t){"use strict";class i extends t.Container{constructor(){super(...arguments),this.layerHeight=0,this.layerWidth=0}}const s={defSpriteAnchor:new t.Point(0,1),debugContainers:!1,usePixiDisplay:!1,roundFontAlpha:!1,injectMiddleware:!0},n={};function r(e){if(!e)return 0;if("number"==typeof e)return e;e=e.length>7?e.substr(3,6):e.substr(1,6);try{return parseInt(e,16)}catch(e){return console.warn("Color parse error:",e.message),0}}var o;function a(e){return e.properties&&e.properties.container?o.DEFAULT:e.gid||e.image?o.IMAGE:null!=e.text?o.TEXT:e.point?o.POINT:e.polygon?o.POLYGON:e.polyline?o.POLYLINE:e.ellipse?o.ELLIPSE:o.DEFAULT}function l(e){let t={};if(e.properties)if(e.properties instanceof Array)for(var i of e.properties){let e=i.value;"color"==i.type&&(e=r(e)),t[i.name]=e}else t=e.properties;const s=e;if(s.gid>0){const e=s.gid,i=!!(1073741824&e),n=!!(2147483648&e),r=!!(536870912&e);t.vFlip=i,t.hFlip=n,t.dFlip=r,s.vFlip=i,s.hFlip=n;const o=536870911&e;s.gid=o}e.parsedProps=t}!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.POINT=1]="POINT",e[e.POLYGON=2]="POLYGON",e[e.POLYLINE=3]="POLYLINE",e[e.ELLIPSE=4]="ELLIPSE",e[e.TEXT=5]="TEXT",e[e.IMAGE=6]="IMAGE"}(o||(o={}));class h extends t.Rectangle{constructor(){super(...arguments),this.name="",this.types=[],this.visible=!0}}class c extends t.Point{constructor(e,t){super(e,t),this.name="",this.types=[],this.visible=!0}}class p extends t.Polygon{constructor(e){super(e),this.name="",this.types=[],this.visible=!0,this._x=0,this._y=0}set x(e){const t=e-this._x;this._x=e;for(let e=0;e<this.points.length;e+=2)this.points[e]+=t}set y(e){const t=e-this._y;this._y=e;for(let e=1;e<this.points.length;e+=2)this.points[e]+=t}get x(){return this._x}get y(){return this._y}getBounds(){let e=new t.Rectangle,i=this._x,s=this._y;for(let t=0;t<this.points.length;t+=2){const n=this.points[t],r=this.points[t+1];e.x=n<e.x?n:e.x,e.y=r<e.y?r:e.y,i=n>i?n:i,s=r>s?r:s}return e.width=i-e.x,e.height=s-e.y,e}get width(){return this.getBounds().width}get height(){return this.getBounds().height}set height(e){const t=e/this.height;for(let e=1;e<this.points.length;e+=2){const i=(this.points[e]-this._y)*t;this.points[e]=this._y+i}}set width(e){const t=e/this.width;for(let e=0;e<this.points.length;e+=2){const i=(this.points[e]-this._x)*t;this.points[e]=this._x+i}}}class d{constructor(e){this.name="",this.types=[],this.visible=!0,this.points=[],this.points=e.slice()}}class u extends t.Ellipse{constructor(e,t,i,s){super(e,t,i,s),this.name="",this.types=[],this.visible=!0}}function g(e){if(!e)return;let i=void 0;const s=a(e);switch(e.x=e.x||0,e.y=e.y||0,s){case o.ELLIPSE:i=new u(e.x+.5*e.width,e.y+.5*e.height,.5*e.width,.5*e.height);break;case o.POLYGON:{const s=e.polygon.map(i=>new t.Point(i.x+e.x,i.y+e.y));i=new p(s);break}case o.POLYLINE:{const s=e.polygon.map(i=>new t.Point(i.x+e.x,i.y+e.y));i=new d(s);break}default:i=new h(e.x,e.y,e.width,e.height)}return i.types=e.type?e.type.split(":"):[],i.visible=e.visible,i.name=e.name,i}var y=Object.freeze({__proto__:null,TiledRect:h,TiledPoint:c,TiledPolygon:p,TiledPolypine:d,TiledEllipse:u,BuildPrimitive:g});class f extends t.Sprite{}function m(e,i){i.name=e.name,i.tiledId=e.id,i.width=e.width||i.width,i.height=e.height||i.height,i.rotation=(e.rotation||0)*Math.PI/180,i.x=e.x||0,i.y=e.y||0,i.visible=null==e.visible||e.visible,i.types=e.type?e.type.split(":"):[],i.primitive=g(e);const n=e.parsedProps;n&&(isNaN(n.opacity)||(i.alpha=Number(n.opacity)),Object.assign(i,n),i.properties=n),i.source=e,s.debugContainers&&setTimeout(()=>{const s=new t.Graphics;s.lineStyle(2,16711680,.7).drawRect(i.x,i.y,e.width,e.height).endFill(),i instanceof t.Sprite&&(s.y-=i.height),i.parent.addChild(s)},30)}function x(e){let n=void 0;return n=(e.type?e.type.split(":"):[]).indexOf("mask")>-1?new f(t.Texture.WHITE):new i,e.gid&&(n instanceof t.Sprite?n.anchor=s.defSpriteAnchor:(n.pivot=s.defSpriteAnchor,n.hitArea=new t.Rectangle(0,0,e.width,e.height))),m(e,n),n}var w=Object.freeze({__proto__:null,ApplyMeta:m,Build:x});function b(e){let i;if(e.image.animation){i=new t.AnimatedSprite(e.image.animation,!!e.parsedProps.autoUpdate||!0);const s=i;s.play&&e.parsedProps.animPlaying&&s.play(),s.loop=void 0===e.parsedProps.animLoop||e.parsedProps.animLoop}else i=new t.Sprite(e.image.texture||t.Texture.EMPTY);e.fromImageLayer||(i.anchor=s.defSpriteAnchor),m(e,i);const n=e.image.objectgroup;n&&(i.primitive=g(n.objects[0]));const r=e.hFlip,o=e.vFlip;return r&&(i.scale.x*=-1,i.anchor.x=1),o&&(i.scale.y*=-1,i.anchor.y=0),i}var T=Object.freeze({__proto__:null,Build:b});function P(e){const n=new i,o=e.text;let a=new t.Text(o.text,{wordWrap:o.wrap,wordWrapWidth:e.width,fill:r(o.color||"#000000")||0,align:o.valign||"top",fontFamily:o.fontfamily||"sans-serif",fontWeight:o.bold?"bold":"normal",fontStyle:o.italic?"italic":"normal",fontSize:o.pixelsize||"16px"});a.name=e.name+"_Text",a.roundPixels=!!s.roundFontAlpha;const l=e.parsedProps;switch(e.properties=[],e.parsedProps={},m(e,n),n.pivot.set(0,0),o.halign){case"right":a.anchor.x=1,a.position.x=e.width;break;case"center":a.anchor.x=.5,a.position.x=.5*e.width;break;default:a.anchor.x=0,a.position.x=0}switch(o.valign){case"bottom":a.anchor.y=1,a.position.y=e.height;break;case"center":a.anchor.y=.5,a.position.y=.5*e.height;break;default:a.anchor.y=0,a.position.y=0}return l&&(a.style.stroke=r(l.strokeColor)||0,a.style.strokeThickness=l.strokeThickness||0,a.style.padding=l.fontPadding||0,Object.assign(a,l)),n.addChild(a),n.text=a,n.properties=l,n}var I=Object.freeze({__proto__:null,Build:P});class v{constructor(e){this.sheets=[],this.images={},e&&e.forEach(e=>{this.add(e)})}add(e){if(!e)throw"Sheet can't be undefined";if(e===this)throw"U can't add self to spritesheet";this.sheets.push(e)}addTexture(e,t){this.images[t]=e}get textures(){let e={};for(const t of this.sheets)Object.assign(e,t.textures);return Object.assign(e,this.images),e}get animations(){let e={};for(const t of this.sheets)Object.assign(e,t.animations);return e}}class _{constructor(e,t){this._tileSets=e,this._sheet=new v,this.baseUrl="",this.loadUnknowImages=!0,t&&this.register(t)}register(e){this._sheet.add(e)}get spritesheet(){return this._sheet}getTileByGid(e,t=this.loadUnknowImages){const i=function(e,t,i){let s=void 0,n=0;for(let t=0;t<e.length;t++)if(e[t].firstgid<=i){s=e[t],n=t;break}if(!s)return console.error("Image with gid:"+i+" not found!"),null;const r=i-s.firstgid;let o=s.tiles.filter(e=>e.id==r)[0],a=Object.assign({},o,{tilesetId:n});return a||(console.error("Load res MISSED gid:"+r),null)}(this._tileSets,this.baseUrl,e);return this.getTileByTile(i,t)}getTileByTile(e,i=this.loadUnknowImages,s=!1){if(!e||!e.image)return;if(e.animation&&!s){const t=this._tileSets[e.tilesetId];e.animation.forEach(e=>{e.texture=this.getTileByTile(t.tiles[e.tileid],i,!0).texture,e.time=e.duration})}const n=this.baseUrl+e.image;let r=this.spritesheet.textures[e.image];return!r&&i&&(r=t.Texture.from(n,{},!1),this._sheet.addTexture(r,e.image)),e.texture=r,e}}let L=!0;function E(e,r){let o;if(o=e instanceof t.LoaderResource?e.data:r,!o||"map"!=o.type)return;L&&(console.log("[TILED] Importer!\neXponenta {rondo.devil[a]gmail.com}"),L=!1);const a=!!s.usePixiDisplay&&void 0!==PIXI.display,l=e.textures?e:void 0,h=new i,c=new RegExp(/^.*[\\\/]/);h.layerHeight=o.height,h.layerWidth=o.width,h.source=o;let p="";if(e instanceof t.LoaderResource&&(h.name=e.url.replace(c,"").split(".")[0],p=e.url.replace(r.baseUrl,""),p=p.match(c)[0]),o.layers){const e=new _(o.tilesets,l);e.baseUrl=p;let t=0;a&&(o.layers=o.layers.reverse());for(let i of o.layers){const s=n[i.type];if(!s){console.warn(`[TILED] Importer can't support ${i.type} layer type!`);continue}const r=s.Build(i,e,t);r&&(t++,h.layers={[i.name]:r},h.addChild(r))}}return h}const O={Parse(e,t){var i=E(e,this);e.stage=i,t()},use(e,t){O.Parse.call(this,e,t)},add(){console.log("[TILED] middleware registered!")}};function j(e){!function(e){if(!e.Container)throw new Error("Cant't find Container in package!");t.Container.prototype.getChildByPath=function(e){if(!this.children||0==this.children.length)return;let t=this;const i=e.split("/"),s=new RegExp("(?:{{0})-?d+(?=})");for(const e of i){if(null==t||!t.children){t=void 0;break}if(0==e.trim().length)continue;const i=t.children,n=e.match(s);if(n){let e=parseInt(n[0]);e<0&&(e+=i.length),t=e>=i.length?void 0:i[e]}else t=t.getChildByName(e)}return t},t.Container.prototype.addGlobalChild=function(...e){this.transform.updateLocalTransform();const i=new t.Matrix,s=this.transform.localTransform.clone().invert();for(let t=0;t<e.length;t++){const n=e[t];n.transform.updateLocalTransform(),i.copyFrom(s),i.append(n.localTransform),e[t].transform.setFromMatrix(i)}return this.addChild(...e)}}(e),function(e){if(!e.DisplayObject)throw new Error("Cant't find DisplayObject in package!");e.DisplayObject.prototype.replaceWithTransform=function(e){e.updateTransform(),e.parent&&e.parent.addChildAt(this,e.parent.getChildIndex(e)),this.pivot.copyFrom(e.pivot),this.position.copyFrom(e.position),this.scale.copyFrom(e.scale),this.rotation=e.rotation,this.updateTransform()}}(e),function(e){if(!e.utils)throw new Error("Cant't find utils in package!");e.utils.EventEmitter.prototype.onceAsync=function(e,t){return new Promise(i=>{this.once(e,i,t)})}}(e)}const C={Build(e,t,n=0){const r=!!s.usePixiDisplay&&void 0!==PIXI.display,o=r?PIXI.display.Layer:{},a=r?PIXI.display.Group:{};l(e);const h=e.parsedProps;if(h.ignore||h.ignoreLoad)return void console.log("[TILED] layer ignored:"+e.name);const c=r?new o(new a(void 0!==h.zOrder?h.zOrder:n,!0)):new i;return c.tiledId=e.id,c.name=e.name,c.visible=e.visible,c.position.set(e.x,e.y),c.alpha=e.opacity||1,m(e,c),c}},S={__gen:{[o.IMAGE](e,t){const i=e,s=i.image?t.getTileByTile(i.image):t.getTileByGid(i.gid);i.image=s;const n=b(i);return s&&s.texture&&(n.texture=s.texture,n.tileFrame=s,i.fromImageLayer&&s.texture.baseTexture.once("update",()=>{n.scale.set(1)})),i.fromImageLayer&&n.anchor.set(0,0),n},[o.TEXT]:(e,t)=>P(e),[o.DEFAULT]:(e,t)=>x(e)},Build(e,t,i=0){const s=e,n=C.Build(e,t,i);if(!n)return;if("imagelayer"===e.type&&!this.__convertLayer(e))return;if(!s.objects||!s.objects.length)return n;const r=s.objects;let h=0;for(let e of r){l(e);const i=a(e),s=(this.__gen[i]||this.__gen[o.DEFAULT]).call(this,e,t);s&&(n.addChildAt(s,h),h++)}return n},__convertLayer:e=>!!e.image&&(e.objects=[{image:{image:e.image},gid:-1,name:e.name,x:e.x+e.offsetx,y:e.y+e.offsety,fromImageLayer:!0,properties:e.properties,parsedProps:e.parsedProps}],!0)};return Object.assign(n,{tilelayer:void 0,objectgroup:S,imagelayer:S,group:void 0}),e.Config=s,e.ContainerBuilder=w,e.CreateStage=E,e.Inject=function(e=window.PIXI,t){e?(t&&Object.assign(s,t),j(e),s.injectMiddleware&&e.Loader.registerPlugin(O)):console.warn("Auto injection works only with globals scoped PIXI, not in modules\nuse 'Loader.registerPlugin(Parser)' otherwith")},e.MultiSpritesheet=v,e.Parser=O,e.Primitives=y,e.SpriteBuilder=T,e.TextBuilder=I,e.TiledContainer=i,e.VERSION="1.1.11",e}({},PIXI);PIXI.TiledOG=TiledOG;
//# sourceMappingURL=pixi5-tiled.js.map

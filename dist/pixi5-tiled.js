var TiledOG=function(e,t){"use strict";class i extends t.Container{constructor(){super(...arguments),this.layerHeight=0,this.layerWidth=0}}const s={defSpriteAnchor:new t.Point(0,1),debugContainers:!1,usePixiDisplay:!1,roundFontAlpha:!1,injectMiddleware:!0,roundPixels:!0},r={};class n{constructor(e){if(this._childs=new Set,!e.animation)throw new Error("Tile has not animation!");this._tile=e,this._animator=new t.AnimatedSprite(e.animation),this._animator.onFrameChange=this.__onFrame.bind(this)}__onFrame(){this._childs.forEach(e=>e.texture=this._animator.texture)}get anim(){return this._animator}add(e,t=!0){if(e&&!this._childs.has(e)){if(e.anim=this,e.tileFrame!==this._tile&&t)throw`Invalid sprite! One Animator per tile type! Pased ${e.tileFrame.id} should be ${this._tile.id}`;this._childs.add(e)}}remove(e){this._childs.delete(e)}}var o;function a(e){return e.properties&&e.properties.container?o.DEFAULT:e.gid||e.image?o.IMAGE:null!=e.text?o.TEXT:e.point?o.POINT:e.polygon?o.POLYGON:e.polyline?o.POLYLINE:e.ellipse?o.ELLIPSE:o.DEFAULT}!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.POINT=1]="POINT",e[e.POLYGON=2]="POLYGON",e[e.POLYLINE=3]="POLYLINE",e[e.ELLIPSE=4]="ELLIPSE",e[e.TEXT=5]="TEXT",e[e.IMAGE=6]="IMAGE"}(o||(o={}));class l extends t.Rectangle{constructor(){super(...arguments),this.name="",this.types=[],this.visible=!0}}class h extends t.Point{constructor(e,t){super(e,t),this.name="",this.types=[],this.visible=!0}}class d extends t.Polygon{constructor(e){super(e),this.name="",this.types=[],this.visible=!0,this._x=0,this._y=0}set x(e){const t=e-this._x;this._x=e;for(let e=0;e<this.points.length;e+=2)this.points[e]+=t}set y(e){const t=e-this._y;this._y=e;for(let e=1;e<this.points.length;e+=2)this.points[e]+=t}get x(){return this._x}get y(){return this._y}getBounds(){let e=new t.Rectangle,i=this._x,s=this._y;for(let t=0;t<this.points.length;t+=2){const r=this.points[t],n=this.points[t+1];e.x=r<e.x?r:e.x,e.y=n<e.y?n:e.y,i=r>i?r:i,s=n>s?n:s}return e.width=i-e.x,e.height=s-e.y,e}get width(){return this.getBounds().width}get height(){return this.getBounds().height}set height(e){const t=e/this.height;for(let e=1;e<this.points.length;e+=2){const i=(this.points[e]-this._y)*t;this.points[e]=this._y+i}}set width(e){const t=e/this.width;for(let e=0;e<this.points.length;e+=2){const i=(this.points[e]-this._x)*t;this.points[e]=this._x+i}}}class c{constructor(e){this.name="",this.types=[],this.visible=!0,this.points=[],this.points=e.slice()}}class p extends t.Ellipse{constructor(e,t,i,s){super(e,t,i,s),this.name="",this.types=[],this.visible=!0}}function u(e){if(!e)return;let i=void 0;const s=a(e);switch(e.x=e.x||0,e.y=e.y||0,s){case o.ELLIPSE:i=new p(e.x+.5*e.width,e.y+.5*e.height,.5*e.width,.5*e.height);break;case o.POLYGON:{const s=e.polygon.map(i=>new t.Point(i.x+e.x,i.y+e.y));i=new d(s);break}case o.POLYLINE:{const s=e.polygon.map(i=>new t.Point(i.x+e.x,i.y+e.y));i=new c(s);break}default:i=new l(e.x,e.y,e.width,e.height)}return i.types=e.type?e.type.split(":"):[],i.visible=e.visible,i.name=e.name,i}var g=Object.freeze({__proto__:null,TiledRect:l,TiledPoint:h,TiledPolygon:d,TiledPolypine:c,TiledEllipse:p,BuildPrimitive:u});function m(e){if(!e)return 0;if("number"==typeof e)return e;e=e.length>7?e.substr(3,6):e.substr(1,6);try{return parseInt(e,16)}catch(e){return console.warn("Color parse error:",e.message),0}}function f(e,t){let i=void 0,s=0;for(let r=0;r<e.length;r++)e[r].firstgid<=t&&(i=e[r],s=r);if(!i)return console.error("Image with gid:"+t+" not found!"),null;const r=t-i.firstgid;let n=void 0;void 0!==i.tiles&&(n=i.tiles.filter(e=>e.id==r)[0]),void 0===n&&(n={id:r});let o=Object.assign({},n,{tilesetId:s});return o||(console.error("Load res MISSED gid:"+r),null)}function y(e){let t={};if(e.properties)if(e.properties instanceof Array)for(var i of e.properties){let e=i.value;"color"==i.type&&(e=m(e)),t[i.name]=e}else t=e.properties;const s=e;if(s.gid>0){const e=s.gid,i=!!(1073741824&e),r=!!(2147483648&e),n=!!(536870912&e);t.vFlip=i,t.hFlip=r,t.dFlip=n,s.vFlip=i,s.hFlip=r;const o=536870911&e;s.gid=o}e.parsedProps=t}function x(e,i){i.name=e.name,i.tiledId=e.id,i.width=e.width||i.width,i.height=e.height||i.height,i.rotation=(e.rotation||0)*Math.PI/180,i.x=e.x||0,i.y=e.y||0,i.visible=null==e.visible||e.visible,i.types=e.type?e.type.split(":"):[],i.primitive=u(e);const r=e.parsedProps;r&&(isNaN(r.opacity)||(i.alpha=Number(r.opacity)),Object.assign(i,r),i.properties=r),i.source=e,s.debugContainers&&setTimeout(()=>{const s=new t.Graphics;s.lineStyle(2,16711680,.7).drawRect(i.x,i.y,e.width,e.height).endFill(),i instanceof t.Sprite&&(s.y-=i.height),i.parent.addChild(s)},30)}class w extends t.Sprite{constructor(e,t=!1,i=!0){super(e.image.texture),this.primitives=[],this.source=e,this.tileFrame=e.image,t&&this.tileFrame.animation&&(this.anim=new n(this.tileFrame)),i&&this.init()}init(){if(x(this.source,this),this.anim){const e=this.anim.anim;this.properties.animPlaying&&e.play(),e.loop=void 0===this.properties.animLoop||!!this.properties.animLoop}this.source.gid&&this.anchor.copyFrom(this.source.anchor||s.defSpriteAnchor);const e=this.tileFrame.objectgroup;e&&(this.primitives=e.objects.map(e=>u(e)));const t=this.source.hFlip,i=this.source.vFlip;t&&(this.scale.x*=-1,this.anchor.x=1),i&&(this.scale.y*=-1,this.anchor.y=0)}set anim(e){e!==this._animator&&(this._animator&&this._animator.remove(this),this._animator=e,e&&e.add(this))}get anim(){return this._animator}clone(){const e=new w(this.source,!0);return e.init(),e}}function _(e){let r=void 0;if((e.type?e.type.split(":"):[]).indexOf("mask")>-1){const e={image:{texture:t.Texture.WHITE,id:-1},fromImageLayer:!0};r=new w(e)}else r=new i,x(e,r);return e.gid&&(r.pivot=s.defSpriteAnchor,r.hitArea=new t.Rectangle(0,0,e.width,e.height)),r}var T=Object.freeze({__proto__:null,Build:_});function b(e){return new w(e,!0)}var v=Object.freeze({__proto__:null,Build:b});function I(e){const r=new i,n=e.text;let o=new t.Text(n.text,{wordWrap:n.wrap,wordWrapWidth:e.width,fill:m(n.color||"#000000")||0,align:n.valign||"top",fontFamily:n.fontfamily||"sans-serif",fontWeight:n.bold?"bold":"normal",fontStyle:n.italic?"italic":"normal",fontSize:n.pixelsize||"16px"});o.name=e.name+"_Text",o.roundPixels=!!s.roundFontAlpha;const a=e.parsedProps;switch(e.properties=[],e.parsedProps={},x(e,r),r.pivot.set(0,0),n.halign){case"right":o.anchor.x=1,o.position.x=e.width;break;case"center":o.anchor.x=.5,o.position.x=.5*e.width;break;default:o.anchor.x=0,o.position.x=0}switch(n.valign){case"bottom":o.anchor.y=1,o.position.y=e.height;break;case"center":o.anchor.y=.5,o.position.y=.5*e.height;break;default:o.anchor.y=0,o.position.y=0}return a&&(o.style.stroke=m(a.strokeColor)||0,o.style.strokeThickness=a.strokeThickness||0,o.style.padding=a.fontPadding||0,Object.assign(o,a)),r.addChild(o),r.text=o,r.properties=a,r}var P=Object.freeze({__proto__:null,Build:I});class L{constructor(e){this.sheets=[],this.images={},e&&e.forEach(e=>{this.add(e)})}add(e){if(!e)throw"Sheet can't be undefined";if(e===this)throw"U can't add self to spritesheet";this.sheets.push(e)}addTexture(e,t){this.images[t]=e}get textures(){let e={};for(const t of this.sheets)Object.assign(e,t.textures);return Object.assign(e,this.images),e}get animations(){let e={};for(const t of this.sheets)Object.assign(e,t.animations);return e}}class E extends t.resources.ImageResource{load(){return new Promise((e,t)=>{const i={onError:t};this.onError.add(i),super.load().then(e)})}}class O extends t.utils.EventEmitter{constructor(e,t){super(),this._tileSets=e,this._sheet=new L,this._loadQueue=0,this.baseUrl="",this.loadUnknowImages=!0,t&&(t.textures?this.register(t):Object.keys(t).forEach(e=>{this._sheet.addTexture(t[e],e)}))}register(e){this._sheet.add(e)}get spritesheet(){return this._sheet}getTileByGid(e,t=this.loadUnknowImages){const i=f(this._tileSets,e);return this.getTileByTile(i,t)}getTileByTile(e,t=this.loadUnknowImages,i=!1){if(!e)return;const s=this._tileSets[e.tilesetId];if(!e.image&&s.image&&(e.fromSheet=!0,e.image=s.image),!e.image)return;e.animation&&!i&&e.animation.forEach(i=>{const r=s.tiles.filter(e=>e.id==i.tileid)[0];r.tilesetId=e.tilesetId,i.texture=this.getTileByTile(r,t,!0).texture,i.time=i.duration});let r=this.spritesheet.textures[e.image];e.lazyLoad=!1;const n=this._relativeToAbsolutePath(this.baseUrl,e.image);return r||(r=this.spritesheet.textures[n]),!r&&t&&(r=this._tryLoadTexture(n,e),e.lazyLoad=!0,this._sheet.addTexture(r,e.image)),r&&e.fromSheet&&(r=this._cropTile(s,e,r)),e.texture=r,e}getTileSetByGid(e){const t=f(this._tileSets,e);if(t)return this._tileSets[t.tilesetId]}_relativeToAbsolutePath(e,t){var i=e.split("/"),s=t.split("/");i.pop();for(var r=0;r<s.length;r++)"."!=s[r]&&(".."==s[r]?i.pop():i.push(s[r]));return"."==i[0]&&i.shift(),i.join("/")}_cropTile(e,i,s){const r=e.columns,n=(e.tilecount,e.margin||0),o=e.spacing||0,a=i.id%r,l=i.id/r|0;return s=new t.Texture(s.baseTexture,new t.Rectangle(n+a*(e.tilewidth+o),n+l*(e.tileheight+o),e.tileheight,e.tilewidth)),this._sheet.addTexture(s,`${i.image}_${i.tilesetId}:${i.id}`),s}_tryLoadTexture(e,i){const s=new E(e,{autoLoad:!1,crossorigin:"anonymous"}),r=new t.Texture(new t.BaseTexture(s));return t.Texture.addToCache(r,e),this._loadQueue++,s.load().then(()=>{r.emit("loaded")}).catch(e=>{console.warn("Tile set image loading error!",i)}).finally(()=>{this._loadQueue--,0===this._loadQueue&&this.emit("loaded")}),r}get loaded(){return this._loadQueue<=0}}class S extends i{}let F=!0;function j(e,t,i=""){F&&(console.log("[TILED] Importer!\neXponenta {rondo.devil[a]gmail.com}"),F=!1);const n=!!s.usePixiDisplay&&void 0!==PIXI.display,o=new S;if(o.layerHeight=t.height,o.layerWidth=t.width,o.source=t,o.tileSet=new O(t.tilesets,e),o.tileSet.baseUrl=i,t.layers){let e=0;n&&(t.layers=t.layers.reverse());for(let i of t.layers){const t=r[i.type];if(!t){console.warn(`[TILED] Importer can't support ${i.type} layer type!`);continue}const s=t.Build(i,o.tileSet,e,o);s&&(e++,o.layers={[i.name]:s},o.addChild(s))}}return o}const C={Parse(e,i){const s=e.data;if(!s||"map"!=s.type)return void i();const r=new RegExp(/^.*[\\\/]/);let n=e.url.replace(this.baseUrl,"");n=n.match(r)[0];const o=[];for(let e=0;e<s.tilesets.length;e++){const t=s.tilesets[e];void 0!==t.source&&o.push(t)}const a=function(){const t=j(e.textures,s,n);t?(t.name=e.url.replace(r,"").split(".")[0],e.stage=t,t.tileSet.loaded?i():t.tileSet.once("loaded",()=>i())):i()};if(o.length>0){const e=new t.Loader;for(let t=0;t<o.length;t++)e.add(n+o[t].source);e.load(()=>{Object.keys(e.resources).forEach(t=>{let i=e.resources[t],n=t.replace(r,"");for(let e=0;e<s.tilesets.length;e++){const t=s.tilesets[e];t.source===n&&Object.assign(t,i.data)}}),a()})}else a()},use(e,t){C.Parse.call(this,e,t)},add(){console.log("[TILED] middleware registered!")}};function B(e){!function(e){if(!e.Container)throw new Error("Cant't find Container in package!");t.Container.prototype.getChildByPath=function(e){if(!this.children||0==this.children.length)return;let t=this;const i=e.split("/"),s=new RegExp("(?:{{0})-?d+(?=})");for(const e of i){if(null==t||!t.children){t=void 0;break}if(0==e.trim().length)continue;const i=t.children,r=e.match(s);if(r){let e=parseInt(r[0]);e<0&&(e+=i.length),t=e>=i.length?void 0:i[e]}else t=t.getChildByName(e)}return t},t.Container.prototype.addGlobalChild=function(...e){this.transform.updateLocalTransform();const i=new t.Matrix,s=this.transform.localTransform.clone().invert();for(let t=0;t<e.length;t++){const r=e[t];r.transform.updateLocalTransform(),i.copyFrom(s),i.append(r.localTransform),e[t].transform.setFromMatrix(i)}return this.addChild(...e)}}(e),function(e){if(!e.DisplayObject)throw new Error("Cant't find DisplayObject in package!");e.DisplayObject.prototype.replaceWithTransform=function(e){e.updateTransform(),e.parent&&e.parent.addChildAt(this,e.parent.getChildIndex(e)),this.pivot.copyFrom(e.pivot),this.position.copyFrom(e.position),this.scale.copyFrom(e.scale),this.rotation=e.rotation,this.updateTransform()}}(e),function(e){if(!e.utils)throw new Error("Cant't find utils in package!");e.utils.EventEmitter.prototype.onceAsync=function(e,t){return new Promise(i=>{this.once(e,i,t)})}}(e)}const A={Build(e,t,r=0){const n=!!s.usePixiDisplay&&void 0!==PIXI.display,o=n?PIXI.display.Layer:{},a=n?PIXI.display.Group:{};y(e);const l=e.parsedProps;if(l.ignore||l.ignoreLoad)return void console.log("[TILED] layer ignored:"+e.name);const h=n?new o(new a(void 0!==l.zOrder?l.zOrder:r,!0)):new i;return h.tiledId=e.id,h.name=e.name,h.visible=e.visible,h.position.set(e.x,e.y),h.alpha=e.opacity||1,x(e,h),h}},k={__gen:{[o.IMAGE](e,t){const i=e,s=i.image?t.getTileByTile(i.image):t.getTileByGid(i.gid);i.image=s;const r=b(i);return i.fromImageLayer&&s.lazyLoad&&s.texture.once("loaded",()=>{r.scale.set(1)}),i.fromImageLayer&&r.anchor.set(0),r},[o.TEXT]:(e,t)=>I(e),[o.DEFAULT]:(e,t)=>_(e)},Build(e,t,i=0){const s=e,r=A.Build(e,t,i);if(!r)return;if("imagelayer"===e.type&&!this.__convertLayer(e))return;if(!s.objects||!s.objects.length)return r;const n=s.objects;let l=0;for(let e of n){y(e);const i=a(e),s=(this.__gen[i]||this.__gen[o.DEFAULT]).call(this,e,t);s&&(r.addChildAt(s,l),l++)}return r},__convertLayer:e=>!!e.image&&(e.objects=[{image:{image:e.image},gid:-1,name:e.name,x:e.x+e.offsetx,y:e.y+e.offsety,fromImageLayer:!0,properties:e.properties,parsedProps:e.parsedProps}],!0)},D={Build(e,t,i=0,r){const o=e,a=r.source,l=A.Build(e,t,i);if(!l)return;const h=this.__decodeData(o),{width:d,height:c}=e,{tileheight:p,tilewidth:u}=a,g=(e,i,r)=>{const o=t.getTileByGid(r),a=new w({image:o,fromImageLayer:!1,gid:r,anchor:{x:0,y:0}});if(a.x=e*u,a.y=i*p-(void 0===o.imageheight?0:o.imageheight-p),a.roundPixels=s.roundPixels,o&&o.animation){const e=l.animators||new Map,t=o.tilesetId+"_"+o.id;let i=e.get(t);i||(i=new n(o),e.set(t,i)),a.anim=i,i.anim.play()}return a};for(let e=0;e<c;e++)for(let t=0;t<d;t++){const i=t+e*d;h[i]&&l.addChild(g(t,e,h[i]))}return l},__decodeData:e=>e.data};return Object.assign(r,{tilelayer:D,objectgroup:k,imagelayer:k,group:void 0}),e.Config=s,e.ContainerBuilder=T,e.CreateStage=j,e.Inject=function(e=window.PIXI,t){e?(t&&Object.assign(s,t),B(e),s.injectMiddleware&&e.Loader.registerPlugin(C)):console.warn("Auto injection works only with globals scoped PIXI, not in modules\nuse 'Loader.registerPlugin(Parser)' otherwith")},e.MultiSpritesheet=L,e.Parser=C,e.Primitives=g,e.SpriteBuilder=v,e.TextBuilder=P,e.TiledContainer=i,e.VERSION="1.1.17",e}({},PIXI);PIXI.TiledOG=TiledOG;
//# sourceMappingURL=pixi5-tiled.js.map

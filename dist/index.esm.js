import{Container as e,Point as t,Rectangle as i,Polygon as s,Ellipse as o,Sprite as n,Graphics as r,Texture as a,AnimatedSprite as l,Text as h,resources as d,utils as c,BaseTexture as p,Matrix as u}from"pixi.js";class g extends e{constructor(){super(...arguments),this.layerHeight=0,this.layerWidth=0}}const y={defSpriteAnchor:new t(0,1),debugContainers:!1,usePixiDisplay:!1,roundFontAlpha:!1,injectMiddleware:!0},f={};function m(e){if(!e)return 0;if("number"==typeof e)return e;e=e.length>7?e.substr(3,6):e.substr(1,6);try{return parseInt(e,16)}catch(e){return console.warn("Color parse error:",e.message),0}}var w;function x(e){return e.properties&&e.properties.container?w.DEFAULT:e.gid||e.image?w.IMAGE:null!=e.text?w.TEXT:e.point?w.POINT:e.polygon?w.POLYGON:e.polyline?w.POLYLINE:e.ellipse?w.ELLIPSE:w.DEFAULT}function b(e){let t={};if(e.properties)if(e.properties instanceof Array)for(var i of e.properties){let e=i.value;"color"==i.type&&(e=m(e)),t[i.name]=e}else t=e.properties;const s=e;if(s.gid>0){const e=s.gid,i=!!(1073741824&e),o=!!(2147483648&e),n=!!(536870912&e);t.vFlip=i,t.hFlip=o,t.dFlip=n,s.vFlip=i,s.hFlip=o;const r=536870911&e;s.gid=r}e.parsedProps=t}!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.POINT=1]="POINT",e[e.POLYGON=2]="POLYGON",e[e.POLYLINE=3]="POLYLINE",e[e.ELLIPSE=4]="ELLIPSE",e[e.TEXT=5]="TEXT",e[e.IMAGE=6]="IMAGE"}(w||(w={}));class T extends i{constructor(){super(...arguments),this.name="",this.types=[],this.visible=!0}}class _ extends s{constructor(e){super(e),this.name="",this.types=[],this.visible=!0,this._x=0,this._y=0}set x(e){const t=e-this._x;this._x=e;for(let e=0;e<this.points.length;e+=2)this.points[e]+=t}set y(e){const t=e-this._y;this._y=e;for(let e=1;e<this.points.length;e+=2)this.points[e]+=t}get x(){return this._x}get y(){return this._y}getBounds(){let e=new i,t=this._x,s=this._y;for(let i=0;i<this.points.length;i+=2){const o=this.points[i],n=this.points[i+1];e.x=o<e.x?o:e.x,e.y=n<e.y?n:e.y,t=o>t?o:t,s=n>s?n:s}return e.width=t-e.x,e.height=s-e.y,e}get width(){return this.getBounds().width}get height(){return this.getBounds().height}set height(e){const t=e/this.height;for(let e=1;e<this.points.length;e+=2){const i=(this.points[e]-this._y)*t;this.points[e]=this._y+i}}set width(e){const t=e/this.width;for(let e=0;e<this.points.length;e+=2){const i=(this.points[e]-this._x)*t;this.points[e]=this._x+i}}}class P{constructor(e){this.name="",this.types=[],this.visible=!0,this.points=[],this.points=e.slice()}}class I extends o{constructor(e,t,i,s){super(e,t,i,s),this.name="",this.types=[],this.visible=!0}}function v(e){if(!e)return;let i=void 0;const s=x(e);switch(e.x=e.x||0,e.y=e.y||0,s){case w.ELLIPSE:i=new I(e.x+.5*e.width,e.y+.5*e.height,.5*e.width,.5*e.height);break;case w.POLYGON:{const s=e.polygon.map(i=>new t(i.x+e.x,i.y+e.y));i=new _(s);break}case w.POLYLINE:{const s=e.polygon.map(i=>new t(i.x+e.x,i.y+e.y));i=new P(s);break}default:i=new T(e.x,e.y,e.width,e.height)}return i.types=e.type?e.type.split(":"):[],i.visible=e.visible,i.name=e.name,i}var L=Object.freeze({__proto__:null,TiledRect:T,TiledPoint:class extends t{constructor(e,t){super(e,t),this.name="",this.types=[],this.visible=!0}},TiledPolygon:_,TiledPolypine:P,TiledEllipse:I,BuildPrimitive:v});class E extends n{}function O(e,t){t.name=e.name,t.tiledId=e.id,t.width=e.width||t.width,t.height=e.height||t.height,t.rotation=(e.rotation||0)*Math.PI/180,t.x=e.x||0,t.y=e.y||0,t.visible=null==e.visible||e.visible,t.types=e.type?e.type.split(":"):[],t.primitive=v(e);const i=e.parsedProps;i&&(isNaN(i.opacity)||(t.alpha=Number(i.opacity)),Object.assign(t,i),t.properties=i),t.source=e,y.debugContainers&&setTimeout(()=>{const i=new r;i.lineStyle(2,16711680,.7).drawRect(t.x,t.y,e.width,e.height).endFill(),t instanceof n&&(i.y-=t.height),t.parent.addChild(i)},30)}function j(e){let t=void 0;return t=(e.type?e.type.split(":"):[]).indexOf("mask")>-1?new E(a.WHITE):new g,e.gid&&(t instanceof n?t.anchor=y.defSpriteAnchor:(t.pivot=y.defSpriteAnchor,t.hitArea=new i(0,0,e.width,e.height))),O(e,t),t}var k=Object.freeze({__proto__:null,ApplyMeta:O,Build:j});function A(e){let t;if(e.image.animation){t=new l(e.image.animation,!!e.parsedProps.autoUpdate||!0);const i=t;i.play&&e.parsedProps.animPlaying&&i.play(),i.loop=void 0===e.parsedProps.animLoop||e.parsedProps.animLoop}else t=new n(e.image.texture||a.EMPTY);t.tileFrame=e.image,e.fromImageLayer||(t.anchor=y.defSpriteAnchor),O(e,t);const i=e.image.objectgroup;i&&(t.primitive=v(i.objects[0]));const s=e.hFlip,o=e.vFlip;return s&&(t.scale.x*=-1,t.anchor.x=1),o&&(t.scale.y*=-1,t.anchor.y=0),t}var F=Object.freeze({__proto__:null,Build:A});function S(e){const t=new g,i=e.text;let s=new h(i.text,{wordWrap:i.wrap,wordWrapWidth:e.width,fill:m(i.color||"#000000")||0,align:i.valign||"top",fontFamily:i.fontfamily||"sans-serif",fontWeight:i.bold?"bold":"normal",fontStyle:i.italic?"italic":"normal",fontSize:i.pixelsize||"16px"});s.name=e.name+"_Text",s.roundPixels=!!y.roundFontAlpha;const o=e.parsedProps;switch(e.properties=[],e.parsedProps={},O(e,t),t.pivot.set(0,0),i.halign){case"right":s.anchor.x=1,s.position.x=e.width;break;case"center":s.anchor.x=.5,s.position.x=.5*e.width;break;default:s.anchor.x=0,s.position.x=0}switch(i.valign){case"bottom":s.anchor.y=1,s.position.y=e.height;break;case"center":s.anchor.y=.5,s.position.y=.5*e.height;break;default:s.anchor.y=0,s.position.y=0}return o&&(s.style.stroke=m(o.strokeColor)||0,s.style.strokeThickness=o.strokeThickness||0,s.style.padding=o.fontPadding||0,Object.assign(s,o)),t.addChild(s),t.text=s,t.properties=o,t}var C=Object.freeze({__proto__:null,Build:S});class B{constructor(e){this.sheets=[],this.images={},e&&e.forEach(e=>{this.add(e)})}add(e){if(!e)throw"Sheet can't be undefined";if(e===this)throw"U can't add self to spritesheet";this.sheets.push(e)}addTexture(e,t){this.images[t]=e}get textures(){let e={};for(const t of this.sheets)Object.assign(e,t.textures);return Object.assign(e,this.images),e}get animations(){let e={};for(const t of this.sheets)Object.assign(e,t.animations);return e}}class D extends d.ImageResource{load(){return new Promise((e,t)=>{const i={onError:t};this.onError.add(i),super.load().then(e)})}}class U extends c.EventEmitter{constructor(e,t){super(),this._tileSets=e,this._sheet=new B,this._loadQueue=0,this.baseUrl="",this.loadUnknowImages=!0,t&&(t.textures?this.register(t):Object.keys(t).forEach(e=>{this._sheet.addTexture(t[e],e)}))}register(e){this._sheet.add(e)}get spritesheet(){return this._sheet}getTileByGid(e,t=this.loadUnknowImages){const i=function(e,t,i){let s=void 0,o=0;for(let t=0;t<e.length;t++)if(e[t].firstgid<=i){s=e[t],o=t;break}if(!s)return console.error("Image with gid:"+i+" not found!"),null;const n=i-s.firstgid;let r=s.tiles.filter(e=>e.id==n)[0],a=Object.assign({},r,{tilesetId:o});return a||(console.error("Load res MISSED gid:"+n),null)}(this._tileSets,this.baseUrl,e);return this.getTileByTile(i,t)}getTileByTile(e,t=this.loadUnknowImages,i=!1){if(!e||!e.image)return;if(e.animation&&!i){const i=this._tileSets[e.tilesetId];e.animation.forEach(e=>{e.texture=this.getTileByTile(i.tiles[e.tileid],t,!0).texture,e.time=e.duration})}const s=this.baseUrl+e.image;let o=this.spritesheet.textures[e.image];return e.lazyLoad=!1,!o&&t&&(o=this._tryLoadTexture(s,e),e.lazyLoad=!0,this._sheet.addTexture(o,e.image)),e.texture=o,e}_tryLoadTexture(e,t){const i=new D(e,{autoLoad:!1,crossorigin:"anonymous"}),s=new a(new p(i));return a.addToCache(s,e),this._loadQueue++,i.load().then(()=>{s.emit("loaded")}).catch(e=>{console.warn("Tile set image loading error!",t)}).finally(()=>{this._loadQueue--,0===this._loadQueue&&(this.emit("loaded"),console.log("loaded"))}),s}get loaded(){return this._loadQueue<=0}}class N extends g{}let G=!0;function z(e,t,i=""){if(!t||"map"!=t.type)return;G&&(console.log("[TILED] Importer!\neXponenta {rondo.devil[a]gmail.com}"),G=!1);const s=!!y.usePixiDisplay&&void 0!==PIXI.display,o=new N;if(o.layerHeight=t.height,o.layerWidth=t.width,o.source=t,o.tileSet=new U(t.tilesets,e),o.tileSet.baseUrl=i,t.layers){let e=0;s&&(t.layers=t.layers.reverse());for(let i of t.layers){const t=f[i.type];if(!t){console.warn(`[TILED] Importer can't support ${i.type} layer type!`);continue}const s=t.Build(i,o.tileSet,e);s&&(e++,o.layers={[i.name]:s},o.addChild(s))}}return o}const M={Parse(e,t){const i=e.data,s=new RegExp(/^.*[\\\/]/);let o=e.url.replace(this.baseUrl,"");o=o.match(s)[0];const n=z(e.textures,i,o);n?(n.name=e.url.replace(s,"").split(".")[0],e.stage=n,n.tileSet.loaded?t():n.tileSet.once("loaded",()=>t())):t()},use(e,t){M.Parse.call(this,e,t)},add(){console.log("[TILED] middleware registered!")}};function X(t){!function(t){if(!t.Container)throw new Error("Cant't find Container in package!");e.prototype.getChildByPath=function(e){if(!this.children||0==this.children.length)return;let t=this;const i=e.split("/"),s=new RegExp("(?:{{0})-?d+(?=})");for(const e of i){if(null==t||!t.children){t=void 0;break}if(0==e.trim().length)continue;const i=t.children,o=e.match(s);if(o){let e=parseInt(o[0]);e<0&&(e+=i.length),t=e>=i.length?void 0:i[e]}else t=t.getChildByName(e)}return t},e.prototype.addGlobalChild=function(...e){this.transform.updateLocalTransform();const t=new u,i=this.transform.localTransform.clone().invert();for(let s=0;s<e.length;s++){const o=e[s];o.transform.updateLocalTransform(),t.copyFrom(i),t.append(o.localTransform),e[s].transform.setFromMatrix(t)}return this.addChild(...e)}}(t),function(e){if(!e.DisplayObject)throw new Error("Cant't find DisplayObject in package!");e.DisplayObject.prototype.replaceWithTransform=function(e){e.updateTransform(),e.parent&&e.parent.addChildAt(this,e.parent.getChildIndex(e)),this.pivot.copyFrom(e.pivot),this.position.copyFrom(e.position),this.scale.copyFrom(e.scale),this.rotation=e.rotation,this.updateTransform()}}(t),function(e){if(!e.utils)throw new Error("Cant't find utils in package!");e.utils.EventEmitter.prototype.onceAsync=function(e,t){return new Promise(i=>{this.once(e,i,t)})}}(t)}const Y={Build(e,t,i=0){const s=!!y.usePixiDisplay&&void 0!==PIXI.display,o=s?PIXI.display.Layer:{},n=s?PIXI.display.Group:{};b(e);const r=e.parsedProps;if(r.ignore||r.ignoreLoad)return void console.log("[TILED] layer ignored:"+e.name);const a=s?new o(new n(void 0!==r.zOrder?r.zOrder:i,!0)):new g;return a.tiledId=e.id,a.name=e.name,a.visible=e.visible,a.position.set(e.x,e.y),a.alpha=e.opacity||1,O(e,a),a}},W={__gen:{[w.IMAGE](e,t){const i=e,s=i.image?t.getTileByTile(i.image):t.getTileByGid(i.gid);i.image=s;const o=A(i);return i.fromImageLayer&&s.lazyLoad&&s.texture.once("loaded",()=>{o.scale.set(1)}),i.fromImageLayer&&o.anchor.set(0),o},[w.TEXT]:(e,t)=>S(e),[w.DEFAULT]:(e,t)=>j(e)},Build(e,t,i=0){const s=e,o=Y.Build(e,t,i);if(!o)return;if("imagelayer"===e.type&&!this.__convertLayer(e))return;if(!s.objects||!s.objects.length)return o;const n=s.objects;let r=0;for(let e of n){b(e);const i=x(e),s=(this.__gen[i]||this.__gen[w.DEFAULT]).call(this,e,t);s&&(o.addChildAt(s,r),r++)}return o},__convertLayer:e=>!!e.image&&(e.objects=[{image:{image:e.image},gid:-1,name:e.name,x:e.x+e.offsetx,y:e.y+e.offsety,fromImageLayer:!0,properties:e.properties,parsedProps:e.parsedProps}],!0)},Q="1.1.13";function R(e=window.PIXI,t){e?(t&&Object.assign(y,t),X(e),y.injectMiddleware&&e.Loader.registerPlugin(M)):console.warn("Auto injection works only with globals scoped PIXI, not in modules\nuse 'Loader.registerPlugin(Parser)' otherwith")}Object.assign(f,{tilelayer:void 0,objectgroup:W,imagelayer:W,group:void 0});export{y as Config,k as ContainerBuilder,z as CreateStage,R as Inject,B as MultiSpritesheet,M as Parser,L as Primitives,F as SpriteBuilder,C as TextBuilder,g as TiledContainer,Q as VERSION};
//# sourceMappingURL=index.esm.js.map
